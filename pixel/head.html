<script id="ze-snippet" src="https://static.zdassets.com/ekr/snippet.js?key={{settings.accountKey}}"></script>
<script>
  window.addEventListener('load', function() {
    var urlPath = document.URL
    var titlePathPreffix = window.decodeURIComponent('{{ settings.titlePreffix }}')
    var titlePath = titlePathPreffix + document.querySelector('head > title').innerText
    var curLocale = document.querySelector('html').lang

    function path(pathArray = [], obj) {
      var result
      for (var i = 0; i < pathArray.length; i++) {
        if (!obj[pathArray[i]]) {
          return result
        }
      }
      return obj[pathArray[pathArray.length]]
    }
    
    zE(function () {
      $zopim(function() {
        zE('webWidget', 'setLocale', curLocale)
        $zopim.livechat.sendVisitorPath({
          url: urlPath,
          title: titlePath
        })
      })

      if (window.__RENDER_8_SESSION__ && window.__RENDER_8_SESSION__.sessionPromise) {
        window.__RENDER_8_SESSION__.sessionPromise.then(function (session) {
          var userEmail = path(['response', 'namespaces', 'authentication', 'storeUserEmail', 'value'], session)
          if (userEmail) {
            zE.identify({
              name: '',
              email: userEmail
            })
          }
        })

      }
    })

    var analytics = window.decodeURIComponent('{{ settings.analytics }}') === 'true'
    var webWidget = JSON.parse(window.decodeURIComponent('{{ settings.webWidget }}'))
    var helpCenterSuppress =  webWidget.helpCenter.suppress
    var departments = webWidget.chat.departments
    var enabled = departments.enabled
    var select = departments.select
    var tags = departments.tags 
    window.zESettings = {
      analytics: analytics,
      webWidget: {
        helpCenter: {
          suppress: helpCenterSuppress
        },
        chat: {
          departments: {
            enabled: enabled,
            select: select,
            tags: tags
          }
        }
      }
    }
})
</script>

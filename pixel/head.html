<script id="ze-snippet" src="https://static.zdassets.com/ekr/snippet.js?key={{settings.accountKey}}"></script>
<script>
  window.addEventListener('load', function() {
    var urlPath = document.URL
    var titlePathPreffix = window.decodeURIComponent('{{ settings.titlePreffix }}')
    var titleEl = document.querySelector('head > title')
    var titlePath = titlePathPreffix + (titleEl ? titleEl.innerText : '')
    var curLocale = document.querySelector('html').lang
    
    function parseValuesToInt(arr = []) {
      return arr.map(function(value) {
        var intValue = parseInt(value)
        if (!isNaN(intValue)) {
          return intValue
        }
        return value
      })
    }
    
    zE(function () {
      $zopim(function() {
        zE('webWidget', 'setLocale', curLocale)
        $zopim.livechat.sendVisitorPath({
          url: urlPath,
          title: titlePath
        })
      })

      if (window.__RENDER_8_SESSION__ && window.__RENDER_8_SESSION__.sessionPromise) {
        window.__RENDER_8_SESSION__.sessionPromise.then(function (session) {
          var userEmail = window.R.path(['response', 'namespaces', 'profile', 'email', 'value'], session) || ''
          var firstName = window.R.path(['response', 'namespaces', 'profile', 'firstName', 'value'], session) || ''
          var lastName = window.R.path(['response', 'namespaces', 'profile', 'lastName', 'value'], session) || ''
          var userName = (firstName ? firstName + ' ' : '') + lastName
          if (userEmail || userName) {
            zE.identify({
              name: userName,
              email: userEmail
            })
          }
        })

      }
    })

    var analytics = window.decodeURIComponent('{{ settings.analytics }}') === 'true'
    var webWidget = JSON.parse(window.decodeURIComponent('{{ settings.webWidget }}'))
    var helpCenterSuppress =  webWidget.helpCenter.suppress
    var departments = webWidget.chat.departments
    var color = webWidget.color
    var enabled = parseValuesToInt(departments.enabled)
    var select = isNaN(parseInt(departments.select)) ? departments.select : parseInt(departments.select)
    var tags = departments.tags
    window.zESettings = {
      analytics: analytics,
      webWidget: {
        color: {
          theme: color.theme
        },
        helpCenter: {
          suppress: helpCenterSuppress
        },
        chat: {
          departments: {
            enabled: enabled,
            select: select,
            tags: tags
          }
        }
      }
    }
})
</script>
